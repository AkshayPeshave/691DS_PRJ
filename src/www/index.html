<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>
		MyMap
		</title>
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

		<link rel="stylesheet" type="text/css" href="leafletJS/leaflet.css">
		<script type="text/javascript" src="leafletJS/leaflet.js"></script>
		<script type="text/javascript" src="js/Bing.js"></script>
		<script src="data/countries.geojson"></script>
		<script src="data/cluster2014.geojson"></script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKMcKR4SlDQ4UaSKNUxQad1NHcIMTY3n0"
    		async defer></script> 
    		<!-- &callback=initialize -->
		<style type="text/css">
			#map { height: 600px;
				width:600px;}
		</style>
		<script>
			var map;
			var geocoder;
			var searchZone=null;

			function init_leafletJS(){
				map = L.map('map').setView([43.8476, 18.3564], 20);

				var cluster2014Layer = L.geoJson(cluster2014, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(feature.properties['CSA2010']);

						layer.on('mouseover', function(e) {
							this.openPopup();
						});
						
						layer.on('mouseout', function(e) {
							this.closePopup();
						});
						
						layer.on('click', function(e) {
							alert('CSA2010 : '+feature.properties['CSA2010']);
						});
					}
				}).addTo(map);
				map.fitBounds(cluster2014Layer.getBounds());

				var bing = new L.BingLayer('Akv9ficRNA2M5yO3irycn60_uQ3Be5QGmspmNBxrNn7I-R6gR7Hm_b9bN6gdAb0O');
                map.addLayer(bing);
			}

			function init_googlemaps() {
				geocoder = new google.maps.Geocoder();
			}
			function codeAddress() {
				var address = document.getElementById('address').value;
				geocoder.geocode( { 'address': address}, function(results, status) {
					if (status == 'OK') {
						var radiusInMetres = parseFloat($( "#slider" ).slider( "value" ))*1609.34;
						var latLng=[results[0].geometry.location.lat(), 
									results[0].geometry.location.lng()]
						drawProximityCircle(latLng, radiusInMetres);
					} else {
						alert('Geocode was not successful for the following reason: ' + status);
					}
				});
			}

			function drawProximityCircle(latLng, radius){
				if(searchZone){
					map.removeLayer(searchZone);
				}
				searchZone = L.circle(latLng, 
					radius,
					{
						color: 'black',
						weight: 1,
						fillColor: 'gray',
						fillOpacity: 0.4
					}).addTo(map);
			}

			function init_pageWidgets(){
				$( "#slider" ).slider({
					value:1,
					min: 0.5,
					max: 6,
					step: 0.5,
					slide: function( event, ui ) {
						$( "#radius" ).val(ui.value + " mi");
					},
					change: function( event, ui ) {
						var radiusInMetres = parseFloat($( "#slider" ).slider( "value" ))*1609.34;
						if(!searchZone) return;
						drawProximityCircle(searchZone.getLatLng(), radiusInMetres);
					}
				});	
				$( "#radius" ).val( $( "#slider" ).slider( "value" ) + " mi");
			}

			function init(){
				init_googlemaps();
				init_leafletJS();
				init_pageWidgets();
			}
		</script>
		
	</head>
	<body onload="init()">
		<h1>My Map</h1>

		<table>
			<tr>
				<td>
					<div id="map"></div>
				</td>
				<td>
					<div>
						<input id="address" type="textbox" value="inner harbor">
						<input type="button" value="Search" onclick="codeAddress()">
					</div>
					
					<p>
					<label for="radius">Search Radius: </label>
					<input type="text" id="radius" readonly style="border:0; color:#f6931f; font-weight:bold;">
					<div id="slider"></div>
					
					</p>
				</td>
			</tr>

		</table>

		
		
		
	</body>
</html>